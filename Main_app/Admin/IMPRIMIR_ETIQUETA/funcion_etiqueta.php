<?php

function PV_006(){

	//Primero se realiza la busqueda de las lineas grabadas en la base de datos
	include("conexion.php");
	$enlace2 = new mysqli($dbhost, $dbuser,$dbpass, $dbname);

	$query="SELECT NOMBRES,APELLIDOS, Documento, INSTITUCION, TAG_RFID, Cargo, NOMBRE_EVENTO FROM registro_evento WHERE etiquetado='1'";

	//"SELECT CONCAT(NOMBRES,APELLIDOS, DOCUMENTO, INSTITUCION, TAG_RFID, CARGO) AS Nombre, Apellido, Documento, Intitucion, RFID, Cargo FROM registro_evento WHERE etiquetado='1'";

	//Sobreescribir archivo imprimiendo.txt --ubicacion en com_pagese
	//if(isset($_POST['zpl']){ }

	if ($result = $enlace2->query($query)) {

		 while ($row = $result->fetch_row()) {

			$et_nombre=$row[0];
			$et_apellido=$row[1];
			$et_documento=$row[2];
			$et_institucion=$row[3];
			$et_RFID=$row[4];
			$et_cargo=$row[5];
			$et_nombre_evento=$row[6];
			$et_fecha=gmdate('Y-m-d');

			$zpl="^XA \n";

			$zpl.=" ^FO40,120^GFA,4644,4644,36,gW01gPFC,03gPFEJ07gQF8,0gRF8001gRFC,1F8gN01FC001gRFE,3EgP03E003gSF,7CgP01E007gSF,78gQ0F007gSF,FgR07007gSF8,EgR07007gSF8,:EgR03007gSF8,::::::::::ET03FF8CS03007gSF8,ER01E3FF8FCR03007gSF8,ER0FE3FF8FF8Q03007gSF8,EQ07FE3FF8IFQ03007gSF8,EQ07FE3FF8IFCP03007gSF8,EP047FE3FF8JFP03007gSF8,EO01C7FE3FF8JFCO03007gSF8,EO0387FE3FF8JFEO03007gSF8,EO0F87FE3FF8KF8N03007gSF8,EN01F87FE3FF8KFCN03007gSF8,EN07F87FE3FF8LFN03007JF7F9IF9OFE7FCKF3IF8,EN0FF87FE3FF8LF8M03007JF3F9IF9OFE7FCKF3IF8,EM01FF87FE3FF8LF8M03007JF3F9IF9OFE7FCKF3IF8,EM01FF87FE3FF8LF8M03007JF3F9VFCKF3IF8,EM01FF87FE3FF8LF8M03007JF3F9CC7DBFBC3EC61EFC4F0FF13IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9C8391F981CI0E700C03C03IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9C3199F318C31EE638CE38E3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9C7I9F27CC73FE67CFF99F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9CF998F27E471FE67CFF99F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9CF99CE6004F87E47CF011F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9CF99CE6004F81E47CC011F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F9CF99C667FCFF0E47CCF91F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF3F1CF99E4E7FCFFC667CCF99F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF1F1CF99E4E7FCFFE667CCF19F3IF8,EM01FF87FE3FF8FFC3FF8M03007JF0E3CF99E0E3ECF7CE638CE18E3IF8,EM01FF87FE3FF8FFC3FF8M03007JF807CF99F1F00CF00E700C01C03IF8,EM01FF87FE3FF8FFC3FF8M03007JFE0FCF99F1FC1CF81E784E19E13IF8,EM01FF87FE3FF8FFC3FF8M03007gSF8,::::::EM01FF87FE3FF8FFC3FF8M03007OF3NF9IF3IF9LF8,EM01FF87FE3FF8FFCQ03007IF9KF3KF9FF9IF3IF9LF8,:EM01FF87FE3FF8FFCQ03007IF9KF3KF9LF3IF9LF8,:EM01FF87FE3FF8FFEIF8M03007IF9C83C133E7020081C0F3FE01E07IF8,EM01FF87FE3FF8LF8M03007IF9C018033E603I018073FE01C03IF8,EM01FF87FE3FF8LF8M03007IF9C799E33E4FF9C79FE33FC718F3IF8,EM01FF87FE3FF8LF8M03007IF9CF91F33E4FF9C79FF33FCF99F9IF8,EM01FF87FE3FF8LF8M03007IF9CF93F33E43F9CF9F033F8F99F9IF8,EM01FF87FE3FF8LF8M03007IF9CF93F33E6079CF9C033F8F9001IF8,EM01FF87FE3FF8LF8M03007IF9CF93F33E7839CF98F33F8F9003IF8,EM01FF87FE3FF8LF8M03007IF9CF93F33E7F19CF99F33F8F99KF8,EM01FF87FE3FF8LF8M03007IF9CF91F33E7F99CF99F33FCF99KF8,EM01FF87FE3FF8I03FF8M03007IF9CF99E33C5F19CF99E33FC718FBIF8,EM01FF87FE3FF8I03FF8M03007IF9CF98030040380F98033FE01C03IF8,EM01FF87FE3FF8I03FF8M03007IF9CF9C1382407C0F9C133FF01E03IF8,EM01FF87FE3FF8I03FF8M03007gSF8,EM01FF87FE3FF8FFC3FF8M03007gSF8,:::::EM01FF87FE3FF8FFC3FF8M03007gJFENF8,EM01FF87FE3FF8FFC3FF8M03007MFE07TFE7MF8,EM01FF87FE3FF8FFC3FF8M03007MFC03LF3MFE7MF8,EM01FF87FE3FF8FFC3FF8M03007MF8F3LF3MFE7MF8,EM01FF87FE3FF8FFC3FF8M03007MF9NF3MFE7MF8,EM01FF87FE3FF8FFC3FF8M03007MF1FFE07906020F90F82783C8IF8,EM01FF87FE3FF8FFC3FF8M03007MF9FFC03802I070070070180IF8,EM01FF87FE3FF8FFC3FF8M03007MF87FDF38733DE30E33C63987IF8,EM01FF87FE3FF8FFC3FF8M03007MF80IF98F33FF31F23C47C8JF8,EM01FF87FE3FF8FFC3FF8M03007MFE03FF99F33FF31F27E4FC8JF8,EM01FF87FE3FF8FFC3FF8M03007NFC3E019F33E031F27E4008JF8,EM01FF87FE3FF8FFC3FF8M03007OF1C299F33C631F27E4008JF8,EM01FF87FE3FF8FFC3FF8M03007OF1CF99F339F31F27E4FF8JF8,EM01FFC7FE3FF8FFC3FF8M03007OF18F19F339F31F27C4FF8JF8,EM01KFE3FF8LF8M03007MF7F18F19F339E31F23C47F8JF8,EM01KFE3FF8LF8M03007MF0C3C619F300C31F31863C8JF8,EM01KFE3FF8LF8M03007MF807C099F380031F3827008JF8,EN0KFE3FF8LF8M03007MFE1FF1KFE3JFC7FC7KF8,EN07JFE3FF8LFN03007gSF8,EN03JFE3FF8KFEN03007gSF8,EN01JFE3FF8KFCN03007gSF8,EO07IFE3FF8KFO03007gSF8,EO03IFE3FF8JFEO03007gSF8,EP0IFE3FF8JF8O03007gSF8,EP03FFE3FF8IFEP03007gSF8,EQ0FFE3FF8IF8P03007gSF8,EQ03FE3FF8FFEQ03007gSF8,ER07E3FF8FFR03007gSF8,ES063FF8FS03007gSF8,ET01FFU03007gSF8,EgR03007gSF8,::::::::::EgR07007gSF8,FgR07007gSF8,7gR0F007gSF,78gQ0F003gSF,7CgP01E003gRFE,3EgP07C001gRFC,1FEgN07FCI0gRF8,0gRFJ03gPFE,01gPFC,^FS \n";


			$zpl.="^FO40, 50^ADN, 30, 30^FD ".$et_nombre_evento."^FS \n";
			$zpl.="^FO330, 120^ADN, 12, 12^FD NOMBRE: ".$et_nombre." ".$et_apellido."^FS  \n";
			$zpl.="^FO330, 150^ADN, 12, 12^FD DOCUMENTO: ".$et_documento."^FS  \n";
			$zpl.="^FO330, 180^ADN, 12, 12^FD INSTITUCION:".$et_institucion." ^FS \n";
			$zpl.="^FO330, 210^ADN, 12, 12^FD CARGO:".$et_cargo."^FS \n";
			$zpl.="^FO330, 240^ADN, 12, 12^FD FECHA DE REGISTRO:".$et_fecha."^FS  \n";

						
			$zpl.="^FO80,280^BY5 \n";
			$zpl.="^BCN,70,Y,N,N \n";
			$zpl.="^FD ".$et_RFID."^FS \n";
			$zpl.="^RS,F11,,1,N^FS \n";
			//$zpl.="^HR,,F10,F40^FS \n"; //CODIGO DE CALIBRACION
			$zpl.="^RB96,96^FS \n";
			$zpl.="^RFW,E^FD".$et_RFID."^FS \n";
			$zpl.="~RVe \n"; // linea de reimpresion
			$zpl.="^XZ \n";


		 }
	}

	$file="../IMPRIMIR_ETIQUETA/imprimir.txt";
	$fp_et = fopen($file, "w")or die ("Problemas al escribir archivo");
	fwrite($fp_et, $zpl);
	fclose($fp_et);
	echo '<script language="javascript">alert("Etiqueta Impresa");</script>';

	//sE COMENTAN PARA TRABAJAR EN LA CASA
	sleep(15);
	pclose(popen("start /B impresora.bat", "r"));
	sleep(5);		//eSTE SLEEP ES DE 5


	 //Cambiando estado a etiquetado
	$sql="UPDATE registro_evento SET etiquetado='2' WHERE etiquetado='1' ";


	if ($enlace2->query($sql) === TRUE) {
		//echo "New record created successfully".$sql;
	} else {
		//echo "Error: " . $sql . "<br>" . $enlace2->error;
	}

	 mysqli_close($enlace2);
	 //return "Etiqueta Impresa";

}

?>
